name: Documentation

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz pandoc groff

    - name: Configure
      run: |
        ./autogen.sh
        ./configure

    - name: Build Documentation
      run: |
        make -C doc
        # Create output directories
        mkdir -p doc/txt doc/md
        # Process Man pages (Section 3)
        for f in doc/man/man3/*.3; do
          filename=$(basename "$f" .3)
          # Convert Man to clean Text using pandoc (avoids ANSI codes from groff)
          pandoc -f man -t plain "$f" -o "doc/txt/${filename}.txt"
          # Convert Man to Markdown using pandoc
          pandoc -f man -t markdown "$f" -o "doc/md/${filename}.md"
        done

    - name: Upload Documentation
      uses: actions/upload-artifact@v4
      with:
        name: opus-docs
        path: |
          doc/html/
          doc/txt/
          doc/md/
